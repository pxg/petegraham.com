<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="Python and Excel for Data Import" />
<meta name="author" content="Pete Graham" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Take the pain out of importing excel data" />
<meta property="og:description" content="Take the pain out of importing excel data" />
<link rel="canonical" href="https://petegraham.com/pr-preview/pr-9/python-and-excel-for-data-import/" />
<meta property="og:url" content="https://petegraham.com/pr-preview/pr-9/python-and-excel-for-data-import/" />
<meta property="og:site_name" content="Pete Graham - CTO" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-01-13T17:25:43+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Python and Excel for Data Import" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Pete Graham"},"dateModified":"2015-01-13T17:25:43+00:00","datePublished":"2015-01-13T17:25:43+00:00","description":"Take the pain out of importing excel data","headline":"Python and Excel for Data Import","mainEntityOfPage":{"@type":"WebPage","@id":"https://petegraham.com/pr-preview/pr-9/python-and-excel-for-data-import/"},"url":"https://petegraham.com/pr-preview/pr-9/python-and-excel-for-data-import/"}</script>
<!-- End Jekyll SEO tag -->

  <title>Pete Graham - CTO - Python and Excel for Data Import</title>
  <link rel="apple-touch-icon" href='/pr-preview/pr-9/assets/images/apple-touch-icon.png'>
  <link rel="icon" type="image/svg+xml" href='/pr-preview/pr-9/assets/images/favicon.svg'>
  <link rel="icon" href='/pr-preview/pr-9/assets/images/favicon.ico'>
  <link rel="manifest" href='/pr-preview/pr-9/assets/images/site.webmanifest'>
  <link rel="icon" type="image/png" sizes="192x192" href='/pr-preview/pr-9/assets/images/web-app-manifest-192x192.png'>
  <link rel="icon" type="image/png" sizes="512x512" href='/pr-preview/pr-9/assets/images/web-app-manifest-512x512.png'>
  <link rel="stylesheet" href='/pr-preview/pr-9/assets/css/style.css'>
  <link rel="alternate" type="application/rss+xml" title="My Blog" href='/pr-preview/pr-9/rss.xml'>
  <link rel="stylesheet" href='/pr-preview/pr-9/assets/css/highlight.css'>
</head>
<body>

  <nav class="main-nav">
  <div class="nav-content">
    <a class="brand" href='/pr-preview/pr-9/'>petegraham.com</a>
    <a href='/pr-preview/pr-9/blog/'>Articles</a>
    <a href='/pr-preview/pr-9/TIL/'>TIL </a>
    <a href='/pr-preview/pr-9/'>About</a>
  </div>
</nav>


  

  <section id="wrapper" class="">
    <article class="post">
    <header>
        <h1>Python and Excel for Data Import</h1>
    </header>
    <section id="post-body">
        <p>This article was originally written when I was running <a href="http://lostpropertyhq.com/">Lost Property</a> with <a href="http://rachbelaid.com">Rachid Belaid</a> and <a href="http://robb.re/">Rob Berry</a>.</p>

<p>It’s a common development need to import a large amount of information into a database for use in an application.</p>

<p>A CMS is normally used to input data into a database, when the amount of data is large then using an Excel document can be a good choice.</p>

<p><img src="/assets/images/posts/clippy.jpg" alt="Clippy &quot;It looks like you want to import lots of data&quot;" /></p>

<p>##Why use Excel? It’s not the 90s!</p>
<ul>
  <li>As strange as it may sound some clients, especially corporate ones, really like Excel. For users already familiar with Excel there is no learning curve.</li>
  <li>It’s a commonly used business tool this means you can integrate more seamlessly with existing workflows.</li>
  <li>It’s good for incomplete data where people may not have 100% of the information they need to import. A CMS or DB with strong data validation will often not allow partial “draft” data.</li>
  <li>There’s no need to give lots of people CMS access. The Excel document can also be approved by a manager before import.</li>
  <li>Excel works offline and is good for people with slow internet connections.</li>
</ul>

<p>##Common problems with Excel import
They are a number of pitfalls for developers working with Excel. The major ones are:</p>

<ol>
  <li>The Excel data doesn’t match the database schema.</li>
  <li>Issues with encodings. In particular when saving the Excel file as CSV for import. They are <a href="http://stackoverflow.com/questions/6002256/is-it-possible-to-force-excel-recognize-utf-8-csv-files-automatically">known issues with Excel and saving UTF-8 encodings to CSV</a>.</li>
</ol>

<p>The first issue can be avoided by creating your Excel document programmatically; you can include validation for fields and even drop-down options for foreign keys. Anyone who has had to import Excel data from a file created by someone with no knowledge of the database structure knows it’s a very painful process!</p>

<p>The second issue can be avoided by reading from Excel directly and bypassing the step of saving to CSV. This has the added benefit that users don’t have to save the Excel file to CSV, some non-technical users can really struggle with this.</p>

<p>##Let’s import some data</p>

<p>I’ll be showing how to import data using <a href="https://www.djangoproject.com/">Django</a> however similar techniques could be used for <a href="http://www.pylonsproject.org/">Pyramid</a>, <a href="http://flask.pocoo.org/">Flask</a> or non-web based Python applications. I’m using PostgreSQL but you could use any database which is supported by your Database library/ORM.</p>

<p>Importing data using Excel is particularly useful on projects where there isn’t a CRUD CMS available.</p>

<p>The complete example Django project is on <a href="https://github.com/LostProperty/python_excel">Github</a>, installation instructions are in the project’s README.</p>

<p>Our app stores information about all the staff who work for a company. Staff are stored in the staff DB table <code class="language-plaintext highlighter-rouge">staff_staff</code> which has the following schema</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql">   <span class="k">Column</span>   <span class="o">|</span>         <span class="k">Type</span>
<span class="c1">------------+----------------------</span>
 <span class="n">id</span>         <span class="o">|</span> <span class="nb">integer</span>
 <span class="n">title</span>      <span class="o">|</span> <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
 <span class="n">first_name</span> <span class="o">|</span> <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
 <span class="n">surname</span>    <span class="o">|</span> <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
 <span class="n">job_id</span>     <span class="o">|</span> <span class="nb">integer</span></code></pre></figure>

<p>Our company has a set list of job titles which are stored in the jobs table <code class="language-plaintext highlighter-rouge">staff_job</code>, the <code class="language-plaintext highlighter-rouge">job_id</code> field in <code class="language-plaintext highlighter-rouge">staff_staff</code> is a foreign key to the jobs table which has the following schema:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"> <span class="k">Column</span> <span class="o">|</span>         <span class="k">Type</span>
<span class="c1">--------+-----------------------</span>
 <span class="n">id</span>     <span class="o">|</span> <span class="nb">integer</span>
 <span class="n">title</span>  <span class="o">|</span> <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span></code></pre></figure>

<p>##Creating the Excel template
We’ll use the <a href="https://xlsxwriter.readthedocs.org/">XlsxWriter</a> library  to create our Excel file, we create an Excel file called staff.xlsx file with the following code:</p>

<p>###1. Create the Excel file and worksheet
In the example project this is done as a custom Django Management command, the complete code can be seen <a href="https://github.com/LostProperty/python_excel/blob/develop/python_excel/staff/management/commands/generate_excel_file.py">here</a>.</p>

<p>The command is run using <code class="language-plaintext highlighter-rouge">python manage.py generate_excel_file</code> and creates a file called ‘staff.xlsx’. I’ll go through the code step by step.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">import</span> <span class="n">xlsxwriter</span>
<span class="n">workbook</span> <span class="o">=</span> <span class="n">xlsxwriter</span><span class="p">.</span><span class="n">Workbook</span><span class="p">(</span><span class="s1">'staff.xlsx'</span><span class="p">)</span>
<span class="n">worksheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="p">.</span><span class="n">add_worksheet</span><span class="p">()</span></code></pre></figure>

<p>Use the xlswriter library to create a workbook. The workbook is our Excel file and each workbook has at least one worksheet.</p>

<p>###2. Write Header Row</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">worksheet</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'Title'</span><span class="p">)</span>
<span class="n">worksheet</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'Firstname'</span><span class="p">)</span>
<span class="n">worksheet</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'Surname'</span><span class="p">)</span>
<span class="n">worksheet</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'Job Title'</span><span class="p">)</span></code></pre></figure>

<p>We can write to the cells in the worksheet specifying the row then column. It’s possible to use the Excel style notation of “A1”, however I find using the numeric style makes it clearer when referencing cells programmatically.</p>

<p>###3. Write Input Rows
We are going to create our Excel file to have 10 input rows. We first add drop-down values for each of the title cells.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">input_rows</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">title_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Mr'</span><span class="p">,</span> <span class="s">'Ms'</span><span class="p">,</span> <span class="s">'Miss'</span><span class="p">,</span> <span class="s">'Mrs'</span><span class="p">]</span>
<span class="n">worksheet</span><span class="p">.</span><span class="n">data_validation</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">input_rows</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">{</span><span class="s">'validate'</span><span class="p">:</span> <span class="s">'list'</span><span class="p">,</span>
    <span class="s">'input_title'</span><span class="p">:</span> <span class="s">'Select value'</span><span class="p">,</span>
    <span class="s">'source'</span><span class="p">:</span> <span class="n">title_list</span><span class="p">})</span></code></pre></figure>

<p>The <a href="http://xlsxwriter.readthedocs.org/en/latest/worksheet.html?highlight=data_validation#data_validation">data_validation function</a> takes the parameters:
<code class="language-plaintext highlighter-rouge">first_row, first_col, last_row, last_col, options</code>, so here we are writing the first 10 rows after the header in the first column.</p>

<p>Next we write the firstname column which is limited to a maximum of 20 characters. If we weren’t bothered about the length on the input (or any other data validation) we could skip this step. The same technique is used for the surname column.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">firstname_max_length</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">worksheet</span><span class="p">.</span><span class="n">data_validation</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">input_rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">{</span><span class="s">'validate'</span><span class="p">:</span> <span class="s">'length'</span><span class="p">,</span>
    <span class="s">'input_title'</span><span class="p">:</span> <span class="s">'Enter value'</span><span class="p">,</span>
    <span class="s">'criteria'</span><span class="p">:</span> <span class="s">'&lt;'</span><span class="p">,</span>
    <span class="s">'value'</span><span class="p">:</span> <span class="n">firstname_max_length</span><span class="p">,</span>
    <span class="s">'error_message'</span><span class="p">:</span> <span class="s">'Max Length is {0}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">firstname_max_length</span><span class="p">)})</span></code></pre></figure>

<p>The job title column is similar to the title column where we use a list for the drop-down. The difference here is we use the Job model to populate the drop-down.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">myapp.models</span> <span class="kn">import</span> <span class="n">Job</span>
<span class="n">job_title_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Job</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">'title'</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
<span class="n">worksheet</span><span class="p">.</span><span class="n">data_validation</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">input_rows</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
    <span class="p">{</span><span class="s">'validate'</span><span class="p">:</span> <span class="s">'list'</span><span class="p">,</span>
    <span class="s">'input_title'</span><span class="p">:</span> <span class="s">'Select value'</span><span class="p">,</span>
    <span class="s">'source'</span><span class="p">:</span> <span class="n">job_title_list</span><span class="p">})</span></code></pre></figure>

<p>Once all your fields have been written to the Excel document you need to close the workbook with <code class="language-plaintext highlighter-rouge">workbook.close()</code>.</p>

<p>##Importing the Excel data
We’ll use <a href="https://openpyxl.readthedocs.org">openpyxl</a> to read the populated Excel file. The reason I use two Excel libraries is because openpyxl is good for reading Excel files. openyxl can write Excel files but XlsxWriter has some more advanced Excel writing features.</p>

<p>In the example project importing the data is done using a custom Django Management command, the complete code can be seen <a href="https://github.com/LostProperty/python_excel/blob/develop/python_excel/staff/management/commands/import_excel_file.py">here</a>.</p>

<p>The command is run using <code class="language-plaintext highlighter-rouge">python manage.py import_excel_file filename.xlsx</code>. I’ll go through what the code does.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">rows</span> <span class="o">=</span> <span class="n">get_excel_data</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></code></pre></figure>

<p>We call a function I’ve created called <code class="language-plaintext highlighter-rouge">get_excel_data</code> with the Excel filename as the argument. The function reads the contents of the Excel file and returns the contents as a list of lists called rows, this variable represents the rows and cells in the document.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">save_staff</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span></code></pre></figure>

<p>Next we call another function called save_staff with rows as the parameter.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">save_staff</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
    <span class="s">"""
    Save the staff to the database
    """</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">employee</span> <span class="o">=</span> <span class="n">Staff</span><span class="p">()</span>
        <span class="n">employee</span><span class="p">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">employee</span><span class="p">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">employee</span><span class="p">.</span><span class="n">surname</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">employee</span><span class="p">.</span><span class="n">job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">employee</span><span class="p">.</span><span class="n">save</span><span class="p">()</span></code></pre></figure>

<p>We loop through the rows saving them to the DB. The value for the employees job is a special case, we use the ORM to perform a look-up as it’s a foreign key.</p>

<p>##Limitations of this technique
Although this technique is useful it does have some limitations:</p>

<ul>
  <li>Difficult to provide complex multi column validation.</li>
  <li>You can’t upload images to an Excel file.</li>
  <li>You can override cell validation by copying and pasting into Excel.</li>
  <li>Can’t provide customs workflows or logic which could be achieved in an application.</li>
</ul>

<h1 id="conclusion">Conclusion</h1>
<p>In conclusion importing data from Excel can be a useful technique to populate a database, you’ll avoid a lot of problems by creating the Excel document using code.</p>

<p>However they are limitations to this technique and you’ll never achieve as good a user interface in Excel and you would using a custom application.</p>

<p>#Further techniques
This tutorial described a simplified version of what we’re using in some projects. We’ve built on these techniques to provide the following features:</p>

<ul>
  <li>Produce an Excel error document when rows can’t be imported.</li>
  <li>Formating in the Excel file: such as custom fonts, styling and setting column widths.</li>
  <li>Images/branding in Excel file.</li>
  <li>Bulk updating data using same technique.</li>
  <li>Getting round the Excel drop-down 256 character limitation by referencing cells.</li>
  <li>Making sure numeric cells display correctly in Excel and don’t use scientific notation.</li>
  <li>Adding text areas to the Excel file for easier input of large blocks of text.</li>
  <li>Introspecting the Django models to avoid code duplication.</li>
</ul>

<p>I’d be happy to provide further information of these in a blog post if it’s of particular interest.</p>

        <p>
        If you'd like to contact me then you can email <a href="mailto:writing@petegraham.co.uk">writing@petegraham.co.uk</a>.
        </p>
    </section>
    <h2 class="headline">January 13, 2015</h2>
</article>
<footer id="post-meta" class="clearfix">
    <a href='/pr-preview/pr-9/'>
        <img class="avatar" src='/pr-preview/pr-9/assets/images/avatar.png' srcset='/pr-preview/pr-9/assets/images/avatar.png 1x, /pr-preview/pr-9/assets/images/avatar@2x.png 2x'>
        <div>
            <span class="dark">Pete Graham</span>
            <span>Bridging Technology Strategy & Business Scaling</span>
        </div>
    </a>

</footer>

<!-- Disqus comments -->


<!-- Archive post list -->
<!-- TODO: hide current post here -->





  </section>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src='/pr-preview/pr-9/assets/js/main.js'></script>
  <script src='/pr-preview/pr-9/assets/js/highlight.js'></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-1161798-1', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>



