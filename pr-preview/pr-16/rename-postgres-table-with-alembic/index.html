<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="Rename Postgres table with Alembic migrations" />
<meta name="author" content="Pete Graham" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Rename PostgreSQL tables, sequences and indexes" />
<meta property="og:description" content="Rename PostgreSQL tables, sequences and indexes" />
<link rel="canonical" href="https://petegraham.com/pr-preview/pr-16/rename-postgres-table-with-alembic/" />
<meta property="og:url" content="https://petegraham.com/pr-preview/pr-16/rename-postgres-table-with-alembic/" />
<meta property="og:site_name" content="Pete Graham - CTO" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-11-27T09:56:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Rename Postgres table with Alembic migrations" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Pete Graham"},"dateModified":"2015-11-27T09:56:00+00:00","datePublished":"2015-11-27T09:56:00+00:00","description":"Rename PostgreSQL tables, sequences and indexes","headline":"Rename Postgres table with Alembic migrations","mainEntityOfPage":{"@type":"WebPage","@id":"https://petegraham.com/pr-preview/pr-16/rename-postgres-table-with-alembic/"},"url":"https://petegraham.com/pr-preview/pr-16/rename-postgres-table-with-alembic/"}</script>
<!-- End Jekyll SEO tag -->

  <title>Pete Graham - CTO - Rename Postgres table with Alembic migrations</title>
  <link rel="apple-touch-icon" href='/pr-preview/pr-16/assets/images/apple-touch-icon.png'>
  <link rel="icon" type="image/svg+xml" href='/pr-preview/pr-16/assets/images/favicon.svg'>
  <link rel="icon" href='/pr-preview/pr-16/assets/images/favicon.ico'>
  <link rel="manifest" href='/pr-preview/pr-16/assets/images/site.webmanifest'>
  <link rel="icon" type="image/png" sizes="192x192" href='/pr-preview/pr-16/assets/images/web-app-manifest-192x192.png'>
  <link rel="icon" type="image/png" sizes="512x512" href='/pr-preview/pr-16/assets/images/web-app-manifest-512x512.png'>
  <link rel="stylesheet" href='/pr-preview/pr-16/assets/css/style.css'>
  <link rel="alternate" type="application/rss+xml" title="My Blog" href='/pr-preview/pr-16/rss.xml'>
  <link rel="stylesheet" href='/pr-preview/pr-16/assets/css/highlight.css'>
</head>
<body>

  <nav class="main-nav">
  <div class="nav-content">
    <a class="brand" href='/pr-preview/pr-16/'>petegraham.com</a>
    <a href='/pr-preview/pr-16/blog/'>Articles</a>
    <a href='/pr-preview/pr-16/TIL/'>TIL </a>
    <a href='/pr-preview/pr-16/'>About</a>
  </div>
</nav>


  

  <section id="wrapper" class="">
    <article class="post">
    <header>
        <h1>Rename Postgres table with Alembic migrations</h1>
        
    </header>
    <section id="post-body">
        <p>In this article I’ll discuss the approach I take to rename Postgres tables using Alembic. This includes renaming all references to the old table name such as sequences and indexes.</p>

<p>I’m a fan of SQLAlchemy and Postgres, I like to use them with Alembic to manage my database migrations. My normal workflow with Alembic is:</p>

<ol>
  <li>Edit SQLAlchemy models</li>
  <li>Auto-generate the migration</li>
</ol>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash">alembic <span class="nt">-c</span> alembic.ini revision <span class="nt">--autogenerate</span> <span class="nt">-m</span> <span class="s2">"Migration description"</span></code></pre></figure>

<ol>
  <li>Run the migration</li>
</ol>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash">alembic <span class="nt">-c</span> alembic.ini upgrade <span class="nb">head</span></code></pre></figure>

<p>Let’s say I have business-critical software which tracks when I buy and eat Marathon bars. Marathon bars were renamed to Snickers in 1990 in the UK so it makes sense to update my software to reflect this, this will help avoid confusion with legacy chocolate bar naming.</p>

<p>I have an SQLAlchemy model called <code class="language-plaintext highlighter-rouge">Marathon</code> which represents a DB table <code class="language-plaintext highlighter-rouge">marathon</code>. I want to rename the model to <code class="language-plaintext highlighter-rouge">Snickers</code> and have my DB table called <code class="language-plaintext highlighter-rouge">snickers</code>. The original <code class="language-plaintext highlighter-rouge">Marathon</code> model looks like this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Marathon</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">'marathon'</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">bought</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">eaten</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></code></pre></figure>

<p>I edit it to look like this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Snickers</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">'snickers'</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">bought</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">eaten</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></code></pre></figure>

<p>I then run:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">alembic <span class="nt">-c</span> alembic.ini revision <span class="nt">--autogenerate</span> <span class="nt">-m</span> <span class="s2">"Renaming Marathon model to Snickers"</span></code></pre></figure>

<p>This produces the following migration for upgrade:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">upgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="p">.</span><span class="n">create_table</span><span class="p">(</span><span class="s">'snickers'</span><span class="p">,</span>
    <span class="n">sa</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="n">sa</span><span class="p">.</span><span class="n">Integer</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="n">sa</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">'weight'</span><span class="p">,</span> <span class="n">sa</span><span class="p">.</span><span class="n">Integer</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="n">sa</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">'bought'</span><span class="p">,</span> <span class="n">sa</span><span class="p">.</span><span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="n">sa</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="s">'eaten'</span><span class="p">,</span> <span class="n">sa</span><span class="p">.</span><span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="n">sa</span><span class="p">.</span><span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="s">'id'</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">op</span><span class="p">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s">'marathon'</span><span class="p">)</span></code></pre></figure>

<p>The migration is dropping the <code class="language-plaintext highlighter-rouge">marathon</code> table and creating a new <code class="language-plaintext highlighter-rouge">snickers</code> table. This is going to be a problem if I want to keep existing data, as it’ll be deleted along with the <code class="language-plaintext highlighter-rouge">marathon</code> table. I need to manually edit the migration to use the alembic <code class="language-plaintext highlighter-rouge">rename_table</code> command:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">upgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="p">.</span><span class="n">rename_table</span><span class="p">(</span><span class="s">'marathon'</span><span class="p">,</span> <span class="s">'snickers'</span><span class="p">)</span></code></pre></figure>

<p>All seems good in the world until I take a look in Postgres. Running <code class="language-plaintext highlighter-rouge">\d</code> shows:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">snacks</span><span class="o">=#</span> <span class="err">\</span><span class="n">d</span>
              <span class="n">List</span> <span class="k">of</span> <span class="n">relations</span>
 <span class="k">Schema</span> <span class="o">|</span>      <span class="n">Name</span>       <span class="o">|</span>   <span class="k">Type</span>   <span class="o">|</span> <span class="k">Owner</span>
<span class="c1">--------+-----------------+----------+--------</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">alembic_version</span> <span class="o">|</span> <span class="k">table</span>    <span class="o">|</span> <span class="n">snacks</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">marathon_id_seq</span> <span class="o">|</span> <span class="n">sequence</span> <span class="o">|</span> <span class="n">snacks</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">snickers</span>        <span class="o">|</span> <span class="k">table</span>    <span class="o">|</span> <span class="n">snacks</span>
<span class="p">(</span><span class="mi">3</span> <span class="k">rows</span><span class="p">)</span></code></pre></figure>

<p>What is the troublesome <code class="language-plaintext highlighter-rouge">marathon_id_seq</code> doing hanging about?</p>

<p>On further inspection of the snickers table <code class="language-plaintext highlighter-rouge">\d snickers</code> I can see that <code class="language-plaintext highlighter-rouge">marathon_id_seq</code> is used for auto-incrementing the id:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">snacks</span><span class="o">=#</span> <span class="err">\</span><span class="n">d</span> <span class="n">snickers</span>
                                  <span class="k">Table</span> <span class="nv">"public.snickers"</span>
 <span class="k">Column</span> <span class="o">|</span>  <span class="k">Type</span>   <span class="o">|</span> <span class="n">Modifiers</span>
<span class="c1">--------+---------+------------------------------------------------------</span>
 <span class="n">id</span>     <span class="o">|</span> <span class="nb">integer</span> <span class="o">|</span> <span class="k">not</span> <span class="k">null</span> <span class="k">default</span> <span class="n">nextval</span><span class="p">(</span><span class="s1">'snickers_id_seq'</span><span class="p">::</span><span class="n">regclass</span><span class="p">)</span></code></pre></figure>

<p>I rename the sequence in the migration like this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">op</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'ALTER SEQUENCE  marathon_id_seq RENAME TO snickers_id_seq'</span><span class="p">)</span></code></pre></figure>

<p>Are we finished? Of course not, this is a development blog post, we need at least three things to go wrong. Let’s inspect the <code class="language-plaintext highlighter-rouge">snickers</code> table again to see our last problem:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">snacks</span><span class="o">=#</span> <span class="err">\</span><span class="n">d</span> <span class="n">snickers</span>
<span class="p">...</span>
<span class="n">Indexes</span><span class="p">:</span>
    <span class="nv">"marathon_pkey"</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span> <span class="n">btree</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span></code></pre></figure>

<p>I’ve got this pesky index <code class="language-plaintext highlighter-rouge">marathon_pkey</code> hanging about. I can rename the index in the migration too:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">op</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'ALTER INDEX marathon_pkey RENAME TO snickers_pkey'</span><span class="p">)</span></code></pre></figure>

<p>This is my finished migration:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">upgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="p">.</span><span class="n">rename_table</span><span class="p">(</span><span class="s">'marathon'</span><span class="p">,</span> <span class="s">'snickers'</span><span class="p">)</span>
    <span class="n">op</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'ALTER SEQUENCE marathon_id_seq RENAME TO snickers_id_seq'</span><span class="p">)</span>
    <span class="n">op</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'ALTER INDEX marathon_pkey RENAME TO snickers_pkey'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">downgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="p">.</span><span class="n">rename_table</span><span class="p">(</span><span class="s">'snickers'</span><span class="p">,</span> <span class="s">'marathon'</span><span class="p">)</span>
    <span class="n">op</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'ALTER SEQUENCE snickers_id_seq RENAME TO marathon_id_seq'</span><span class="p">)</span>
    <span class="n">op</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'ALTER INDEX snickers_pkey RENAME TO marathon_pkey'</span><span class="p">)</span></code></pre></figure>

<p>Remember kids, winners don’t do drugs and they always write downgrade database migrations.</p>

<p>It would be amazing if Alembic could automatically produce these type of rename migrations but I’m not sure if this is possible to implement. One solution would be to add an extra command to Alembic especially for renaming tables. The code for my example project is over on <a href="https://github.com/pxg/alembic_rename">Github</a>.</p>

        <p>
        If you'd like to contact me then you can email <a href="mailto:writing@petegraham.co.uk">writing@petegraham.co.uk</a>.
        </p>
    </section>
    <h2 class="headline">November 27, 2015</h2>
</article>
<footer id="post-meta" class="clearfix">
    <a href='/pr-preview/pr-16/'>
        <img class="avatar" src='/pr-preview/pr-16/assets/images/avatar.png' srcset='/pr-preview/pr-16/assets/images/avatar.png 1x, /pr-preview/pr-16/assets/images/avatar@2x.png 2x'>
        <div>
            <span class="dark">Pete Graham</span>
            <span>Bridging Technology Strategy & Business Scaling</span>
        </div>
    </a>

</footer>

<!-- Disqus comments -->


<!-- Archive post list -->
<!-- TODO: hide current post here -->





  </section>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src='/pr-preview/pr-16/assets/js/main.js'></script>
  <script src='/pr-preview/pr-16/assets/js/highlight.js'></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-1161798-1', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>



